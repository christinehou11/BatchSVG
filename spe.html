<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>NA • BatchSVG</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="NA"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">BatchSVG</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/spe.html">Find Bias Features - Spatial Transcriptomics Data</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/christinehou11/BatchSVG/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>NA</h1>
      <small class="dont-index">Source: <a href="https://github.com/christinehou11/BatchSVG/blob/main/spe.md" class="external-link"><code>spe.md</code></a></small>
    </div>


<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a></h3>
<p><code>BatchSVG</code> is the R/Bioconductor package for spatial transcriptomics data quality control (QC). As the feature-based QC method, the package provides functions to identify the biased features associated with the batch effect(s) (e.g. sample, slide, and sex) in spatially variable genes (SVGs) using binomial deviance model, aiming to develop the downstream clustering performances and remove the technical noises caused by batch effects. The package works with <a href="https://github.com/drighelli/SpatialExperiment" class="external-link">SpatialExperiment</a> objects.</p>
</div>
<div class="section level3">
<h3 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a></h3>
<p>(After accepted in <a href="https://bioconductor.org/" class="external-link">Bioconductor</a>).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://bioconductor.github.io/BiocManager/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"HuBMAPR"</span><span class="op">)</span></span></code></pre></div>
<p>Install the development version from <a href="https://christinehou11.github.io/BatchSVG">GitHub</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install</span><span class="op">(</span><span class="st">"christinehou11/BatchSVG"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="biased-feature-identification">Biased Feature Identification<a class="anchor" aria-label="anchor" href="#biased-feature-identification"></a></h3>
<p>In this section, we will include the standard workflow for using <code>BatchSVG</code> to show how the method help to detect and visualize the biased features in SVGs.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/christinehou11/BatchSVG" class="external-link">BatchSVG</a></span><span class="op">)</span></span>
<span><span class="co"># library(humanHippocampus2024)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ExperimentHub</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/drighelli/SpatialExperiment" class="external-link">SpatialExperiment</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/SummarizedExperiment" class="external-link">SummarizedExperiment</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a></h4>
<p>We will use the <code>spatially-resolved transcriptomics (SRT)</code> dataset from the adjacent tissue sections of the anterior human hippocampus across ten adult neurotypical donors. The dataset is obtained from <code>humanHippocampus2024</code> package which currently is in the <a href="https://bioconductor.org/packages/humanHippocampus2024/" class="external-link">development version</a> on Bioconductor 3.21, and it is the <code>spatialExperiment</code> object generated and processed from the <a href="https://github.com/LieberInstitute/spatial_hpc" class="external-link">spatial_HPC</a> project.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>ehub <span class="ot">&lt;-</span> <span class="fu">ExperimentHub</span>()</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>spe <span class="ot">&lt;-</span> ehub[[<span class="st">"EH9605"</span>]]</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>spe</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>class<span class="sc">:</span> SpatialExperiment </span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>dim<span class="sc">:</span> <span class="dv">31483</span> <span class="dv">150917</span> </span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="fu">metadata</span>(<span class="dv">1</span>)<span class="sc">:</span> Obtained_from</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="fu">assays</span>(<span class="dv">2</span>)<span class="sc">:</span> counts logcounts</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="fu">rownames</span>(<span class="dv">31483</span>)<span class="sc">:</span> MIR1302<span class="dv">-2</span>HG AL627309<span class="fl">.1</span> ... AC007325<span class="fl">.4</span> AC007325<span class="fl">.2</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>rowData <span class="fu">names</span>(<span class="dv">7</span>)<span class="sc">:</span> source type ... gene_type gene_search</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="fu">colnames</span>(<span class="dv">150917</span>)<span class="sc">:</span> AAACAACGAATAGTTC<span class="dv">-1</span>_V10B01<span class="dv">-086</span>_D1 AAACAAGTATCTCCCA<span class="dv">-1</span>_V10B01<span class="dv">-086</span>_D1 ...</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>  TTGTTTCCATACAACT<span class="dv">-1</span>_Br2720_B1 TTGTTTGTATTACACG<span class="dv">-1</span>_Br2720_B1</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>colData <span class="fu">names</span>(<span class="dv">150</span>)<span class="sc">:</span> sample_id in_tissue ... nmf99 nmf100</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="fu">reducedDimNames</span>(<span class="dv">3</span>)<span class="sc">:</span> <span class="dv">10</span>x_pca <span class="dv">10</span>x_tsne <span class="dv">10</span>x_umap</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>mainExpName<span class="sc">:</span> <span class="cn">NULL</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="fu">altExpNames</span>(<span class="dv">0</span>)<span class="sc">:</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>spatialCoords <span class="fu">names</span>(<span class="dv">2</span>) <span class="sc">:</span> pxl_col_in_fullres pxl_row_in_fullres</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>imgData <span class="fu">names</span>(<span class="dv">4</span>)<span class="sc">:</span> sample_id image_id data scaleFactor</span></code></pre></div>
<p>We will use the spatially variable genes set generated from <a href="https://github.com/LieberInstitute/spatial_hpc" class="external-link">spatial_HPC</a> project. The result is generated from <a href="(https://www.nature.com/articles/s41467-023-39748-z)" class="external-link">nnSVG</a> package.</p>
<p>We will select four samples from the raw data as an example:</p>
<ul><li><p>V11L05-333_B1</p></li>
<li><p>V11L05-333_D1</p></li>
<li><p>V11L05-335_D1</p></li>
<li><p>V11L05-336_A1.</p></li>
</ul><div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>fix_order <span class="ot">&lt;-</span> <span class="fu">distinct</span>(</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    <span class="fu">as.data.frame</span>(<span class="fu">colData</span>(spe)), slide, array, brnum, sample_id, </span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    position, sex) <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    <span class="fu">arrange</span>(slide, array)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>sub4 <span class="ot">&lt;-</span> fix_order<span class="sc">$</span>sample_id[<span class="fu">c</span>(<span class="dv">14</span>,<span class="dv">16</span>, <span class="dv">20</span>,<span class="dv">21</span>)]</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>spe_sub4 <span class="ot">&lt;-</span> spe[,spe<span class="sc">$</span>sample_id <span class="sc">%in%</span> sub4]</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>spe_sub4 <span class="co"># 31483, 18945</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>class<span class="sc">:</span> SpatialExperiment </span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>dim<span class="sc">:</span> <span class="dv">31483</span> <span class="dv">18945</span> </span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="fu">metadata</span>(<span class="dv">1</span>)<span class="sc">:</span> Obtained_from</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="fu">assays</span>(<span class="dv">2</span>)<span class="sc">:</span> counts logcounts</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="fu">rownames</span>(<span class="dv">31483</span>)<span class="sc">:</span> MIR1302<span class="dv">-2</span>HG AL627309<span class="fl">.1</span> ... AC007325<span class="fl">.4</span> AC007325<span class="fl">.2</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>rowData <span class="fu">names</span>(<span class="dv">7</span>)<span class="sc">:</span> source type ... gene_type gene_search</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a><span class="fu">colnames</span>(<span class="dv">18945</span>)<span class="sc">:</span> AAACAACGAATAGTTC<span class="dv">-1</span>_V11L05<span class="dv">-333</span>_B1 AAACAAGTATCTCCCA<span class="dv">-1</span>_V11L05<span class="dv">-333</span>_B1 ...</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>  TTGTTTGTATTACACG<span class="dv">-1</span>_V11L05<span class="dv">-336</span>_A1 TTGTTTGTGTAAATTC<span class="dv">-1</span>_V11L05<span class="dv">-336</span>_A1</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>colData <span class="fu">names</span>(<span class="dv">150</span>)<span class="sc">:</span> sample_id in_tissue ... nmf99 nmf100</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a><span class="fu">reducedDimNames</span>(<span class="dv">3</span>)<span class="sc">:</span> <span class="dv">10</span>x_pca <span class="dv">10</span>x_tsne <span class="dv">10</span>x_umap</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>mainExpName<span class="sc">:</span> <span class="cn">NULL</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a><span class="fu">altExpNames</span>(<span class="dv">0</span>)<span class="sc">:</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>spatialCoords <span class="fu">names</span>(<span class="dv">2</span>) <span class="sc">:</span> pxl_col_in_fullres pxl_row_in_fullres</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>imgData <span class="fu">names</span>(<span class="dv">4</span>)<span class="sc">:</span> sample_id image_id data scaleFactor</span></code></pre></div>
<p>We will refine our selection to include only the top 2,000 ranked features (rank<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>≤</mo><annotation encoding="application/x-tex">\leq</annotation></semantics></math> 2000) and only genes that appear in more than one sample (n &gt; 1).</p>
<p>After applying these criteria, we obtain 2,082 spatially variable genes across the four samples.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># res_ranks: SVGs results with rank values</span></span>
<span><span class="va">res_df_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames_to_column</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">res_ranks</span><span class="op">)</span>, <span class="va">var</span><span class="op">&lt;-</span><span class="st">"gene_id"</span><span class="op">)</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">res_ranks</span><span class="op">)</span>, </span>
<span>    names_to<span class="op">=</span><span class="st">"sample_id"</span>, </span>
<span>    values_to<span class="op">=</span><span class="st">"rank"</span>, </span>
<span>    values_drop_na<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    </span>
<span><span class="va">res_df_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">res_df_sub</span>,</span>
<span>    <span class="va">sample_id</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"V11L05-333_B1"</span>, <span class="st">"V11L05-333_D1"</span>, <span class="st">"V11L05-335_D1"</span>, <span class="st">"V11L05-336_A1"</span><span class="op">)</span>, </span>
<span>    <span class="va">rank</span> <span class="op">&lt;=</span> <span class="fl">2000</span><span class="op">)</span> <span class="co"># top 2k sig features</span></span>
<span>    </span>
<span><span class="va">svgs_sub4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">res_df_sub</span>, <span class="va">gene_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">tally</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">n</span><span class="op">&gt;</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] 2082</code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">svgs_sub4</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="perform-feature-selection-using-featureselect">Perform Feature Selection using <code>featureSelect()</code>
<a class="anchor" aria-label="anchor" href="#perform-feature-selection-using-featureselect"></a></h4>
<p>We will perform feature selection on a subset of spatial transcriptomics data (<em>input</em>) using a predefined set of spatially variable genes (<em>VGs</em>). Specifically, we will compute the number of standard deviations for the relative change in deviance (<strong>nSD_dev_{batch effect}</strong>) and rank difference (<strong>nSD_rank_{batch effect}</strong>) before and after adjusting for batch effects.</p>
<p>The <code><a href="reference/featureSelect.html">featureSelect()</a></code> function enables feature selection while accounting for multiple batch effects. It returns a <strong>list</strong> of data frames, where each batch effect is associated with a corresponding data frame containing key results, including:</p>
<ul><li><p>Relative change in deviance before and after batch effect adjustment</p></li>
<li><p>Rank differences between the batch-corrected and uncorrected results</p></li>
<li><p>Number of standard deviations (nSD) for both relative change in deviance and rank difference</p></li>
</ul><p>We will use the example of applying <code><a href="reference/featureSelect.html">featureSelect()</a></code> to a four sample dataset while adjusting for the batch effect <em>sample_id</em> and <em>sex</em>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>SVGs <span class="ot">&lt;-</span> svgs_sub4<span class="sc">$</span>gene_id</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>list_batch_df <span class="ot">&lt;-</span> <span class="fu">featureSelect</span>(<span class="at">input =</span> spe_sub4, </span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>    <span class="at">batch_effect =</span> <span class="fu">c</span>(<span class="st">"sample_id"</span>, <span class="st">"sex"</span>), <span class="at">VGs =</span> SVGs)</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>Running feature selection without batch...</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>Batch Effect<span class="sc">:</span>sample_id</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>Running feature selection without batch...</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>Calculating deviance and rank difference...</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>Batch Effect<span class="sc">:</span>sex</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>Running feature selection without batch...</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>Calculating deviance and rank difference...</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">class</span>(list_batch_df)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"list"</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">head</span>(list_batch_df<span class="sc">$</span>sample_id)</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>          gene_id gene_name dev_default rank_default dev_sample_id rank_sample_id       d_diff</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="dv">1</span> ENSG00000131584     ACAP3    <span class="fl">16125.31</span>         <span class="dv">1262</span>      <span class="fl">15900.14</span>           <span class="dv">1269</span> <span class="fl">0.0141612453</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="dv">2</span> ENSG00000175756  AURKAIP1    <span class="fl">17344.09</span>         <span class="dv">1060</span>      <span class="fl">17167.86</span>           <span class="dv">1058</span> <span class="fl">0.0102651525</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="dv">3</span> ENSG00000242485    MRPL20    <span class="fl">17629.33</span>         <span class="dv">1023</span>      <span class="fl">17517.05</span>           <span class="dv">1004</span> <span class="fl">0.0064098269</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="dv">4</span> ENSG00000179403      VWA1    <span class="fl">12860.93</span>         <span class="dv">1726</span>      <span class="fl">12825.66</span>           <span class="dv">1702</span> <span class="fl">0.0027493688</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="dv">5</span> ENSG00000160075     SSU72    <span class="fl">16145.20</span>         <span class="dv">1255</span>      <span class="fl">16136.31</span>           <span class="dv">1220</span> <span class="fl">0.0005506572</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="dv">6</span> ENSG00000078369      GNB1    <span class="fl">22402.83</span>          <span class="dv">516</span>      <span class="fl">22271.32</span>            <span class="dv">497</span> <span class="fl">0.0059049925</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>  nSD_dev_sample_id r_diff nSD_rank_sample_id</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="dv">1</span>       <span class="sc">-</span><span class="fl">0.09513109</span>      <span class="dv">7</span>         <span class="fl">0.16380252</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="dv">2</span>       <span class="sc">-</span><span class="fl">0.16945410</span>     <span class="sc">-</span><span class="dv">2</span>        <span class="sc">-</span><span class="fl">0.04680072</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="dv">3</span>       <span class="sc">-</span><span class="fl">0.24299943</span>    <span class="sc">-</span><span class="dv">19</span>        <span class="sc">-</span><span class="fl">0.44460683</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="dv">4</span>       <span class="sc">-</span><span class="fl">0.31282741</span>    <span class="sc">-</span><span class="dv">24</span>        <span class="sc">-</span><span class="fl">0.56160863</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="dv">5</span>       <span class="sc">-</span><span class="fl">0.35477067</span>    <span class="sc">-</span><span class="dv">35</span>        <span class="sc">-</span><span class="fl">0.81901258</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a><span class="dv">6</span>       <span class="sc">-</span><span class="fl">0.25262980</span>    <span class="sc">-</span><span class="dv">19</span>        <span class="sc">-</span><span class="fl">0.44460683</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">head</span>(list_batch_df<span class="sc">$</span>sex)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>          gene_id gene_name dev_default rank_default  dev_sex rank_sex       d_diff nSD_dev_sex</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="dv">1</span> ENSG00000131584     ACAP3    <span class="fl">16125.31</span>         <span class="dv">1262</span> <span class="fl">16118.48</span>     <span class="dv">1250</span> <span class="fl">4.234208e-04</span>  <span class="sc">-</span><span class="fl">0.2615600</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="dv">2</span> ENSG00000175756  AURKAIP1    <span class="fl">17344.09</span>         <span class="dv">1060</span> <span class="fl">17247.44</span>     <span class="dv">1064</span> <span class="fl">5.603690e-03</span>  <span class="sc">-</span><span class="fl">0.1013769</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="dv">3</span> ENSG00000242485    MRPL20    <span class="fl">17629.33</span>         <span class="dv">1023</span> <span class="fl">17585.70</span>     <span class="dv">1013</span> <span class="fl">2.480783e-03</span>  <span class="sc">-</span><span class="fl">0.1979427</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="dv">4</span> ENSG00000179403      VWA1    <span class="fl">12860.93</span>         <span class="dv">1726</span> <span class="fl">12860.90</span>     <span class="dv">1709</span> <span class="fl">1.811106e-06</span>  <span class="sc">-</span><span class="fl">0.2745969</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="dv">5</span> ENSG00000160075     SSU72    <span class="fl">16145.20</span>         <span class="dv">1255</span> <span class="fl">16141.12</span>     <span class="dv">1243</span> <span class="fl">2.527558e-04</span>  <span class="sc">-</span><span class="fl">0.2668373</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="dv">6</span> ENSG00000078369      GNB1    <span class="fl">22402.83</span>          <span class="dv">516</span> <span class="fl">22314.17</span>      <span class="dv">509</span> <span class="fl">3.973515e-03</span>  <span class="sc">-</span><span class="fl">0.1517848</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>  r_diff nSD_rank_sex</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="dv">1</span>    <span class="sc">-</span><span class="dv">12</span>   <span class="sc">-</span><span class="fl">0.3080188</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="dv">2</span>      <span class="dv">4</span>    <span class="fl">0.1026729</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a><span class="dv">3</span>    <span class="sc">-</span><span class="dv">10</span>   <span class="sc">-</span><span class="fl">0.2566824</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a><span class="dv">4</span>    <span class="sc">-</span><span class="dv">17</span>   <span class="sc">-</span><span class="fl">0.4363600</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="dv">5</span>    <span class="sc">-</span><span class="dv">12</span>   <span class="sc">-</span><span class="fl">0.3080188</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a><span class="dv">6</span>     <span class="sc">-</span><span class="dv">7</span>   <span class="sc">-</span><span class="fl">0.1796776</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="visualize-svg-selection-using-svg_nsd-for-batch-effects">Visualize SVG Selection Using <code>svg_nSD</code> for Batch Effects<a class="anchor" aria-label="anchor" href="#visualize-svg-selection-using-svg_nsd-for-batch-effects"></a></h4>
<p>The <code><a href="reference/svg_nSD.html">svg_nSD()</a></code> function generates visualizations to assess batch effects in spatially variable genes (SVGs). It produces bar charts showing the distribution of SVGs based on relative change in deviance and rank difference, with colors representing different nSD intervals. Additionally, scatter plots compare deviance and rank values with and without batch effects.</p>
<p>By interpreting these plots, we can determine appropriate nSD thresholds for filtering biased features. The left panels illustrate the distribution of SVGs in terms of deviance and rank difference, while the right panels compare values before and after accounting for batch effects.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/svg_nSD.html">svg_nSD</a></span><span class="op">(</span>list_batch_df <span class="op">=</span> <span class="va">list_batch_df</span>, </span>
<span>                sd_interval_dev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">4</span><span class="op">)</span>, sd_interval_rank <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">plots</span><span class="op">$</span><span class="va">sample_id</span></span></code></pre></div>
<div class="float">
<img src="figure/svg%20nSD%20two%20plots-1.png" alt="plot of chunk svg nSD two plots"><div class="figcaption">plot of chunk svg nSD two plots</div>
</div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">$</span><span class="va">sex</span></span></code></pre></div>
<div class="float">
<img src="figure/svg%20nSD%20two%20plots-2.png" alt="plot of chunk svg nSD two plots"><div class="figcaption">plot of chunk svg nSD two plots</div>
</div>
<p>We can also apply <code><a href="reference/svg_nSD.html">svg_nSD()</a></code> to a single batch effect. Note that the function requires the input to be a list of data frames, even when analyzing only one batch.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/svg_nSD.html">svg_nSD</a></span><span class="op">(</span>list_batch_df <span class="op">=</span> <span class="va">list_batch_df</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>                sd_interval_dev <span class="op">=</span> <span class="fl">5</span>, sd_interval_rank <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span><span class="va">plots</span><span class="op">$</span><span class="va">sample_id</span></span></code></pre></div>
<div class="float">
<img src="figure/svg%20nSD%20one%20plot-1.png" alt="plot of chunk svg nSD one plot"><div class="figcaption">plot of chunk svg nSD one plot</div>
</div>
</div>
<div class="section level4">
<h4 id="identify-biased-genes-using-biasdetect">Identify Biased Genes Using <code>biasDetect()</code>
<a class="anchor" aria-label="anchor" href="#identify-biased-genes-using-biasdetect"></a></h4>
<p>The function <code><a href="reference/biasDetect.html">biasDetect()</a></code> is designed to identify and filter out biased genes across different batch effects. Using threshold values selected from the visualization results generated by <code><a href="reference/svg_nSD.html">svg_nSD()</a></code>, this function systematically detects outliers that exceed a specified normalized standard deviation (nSD) threshold in either relative deviance change, rank difference, or both.</p>
<p>The function outputs visualizations comparing deviance and rank values with and without batch effects. Genes with high deviations, highlighted in color, are identified as potentially biased and can be excluded based on the selected nSD thresholds.</p>
<p>We will use <code>nSD_dev = 7</code> and <code>nSD_rank = 6</code> as the example. The user should adjust the value based on their dataset features.</p>
<p><strong>Usage of Different Threshold Options</strong></p>
<ul><li>
<code>threshold = "dev"</code>: Filters biased genes based only on the relative change in deviance. Genes with deviance changes exceeding the specified <code>nSD_dev</code> threshold are identified as batch-affected and can be removed.</li>
</ul><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bias_dev</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/biasDetect.html">biasDetect</a></span><span class="op">(</span>list_batch_df <span class="op">=</span> <span class="va">list_batch_df</span>, </span>
<span>                        threshold <span class="op">=</span> <span class="st">"dev"</span>, nSD_dev <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">head</span>(bias_dev<span class="sc">$</span>sample_id<span class="sc">$</span>Table)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>          gene_id gene_name dev_default rank_default dev_sample_id rank_sample_id    d_diff</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="dv">1</span> ENSG00000174576     NPAS4    <span class="fl">35003.31</span>          <span class="dv">125</span>     <span class="fl">24629.414</span>            <span class="dv">363</span> <span class="fl">0.4211996</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="dv">2</span> ENSG00000123358     NR4A1    <span class="fl">23299.81</span>          <span class="dv">457</span>     <span class="fl">16115.928</span>           <span class="dv">1226</span> <span class="fl">0.4457631</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="dv">3</span> ENSG00000170345       FOS    <span class="fl">42305.65</span>           <span class="dv">73</span>     <span class="fl">27146.089</span>            <span class="dv">263</span> <span class="fl">0.5584435</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="dv">4</span> ENSG00000256618  MTRNR2L1    <span class="fl">69206.34</span>           <span class="dv">28</span>     <span class="fl">24876.086</span>            <span class="dv">351</span> <span class="fl">1.7820430</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="dv">5</span> ENSG00000118271       TTR  <span class="fl">4719046.58</span>            <span class="dv">1</span>   <span class="fl">3292127.945</span>              <span class="dv">1</span> <span class="fl">0.4334335</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="dv">6</span> ENSG00000229807      XIST    <span class="fl">15223.50</span>         <span class="dv">1408</span>      <span class="fl">8819.689</span>           <span class="dv">2050</span> <span class="fl">0.7260812</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>  nSD_dev_sample_id r_diff nSD_rank_sample_id nSD_bin_dev dev_outlier</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a><span class="dv">1</span>          <span class="fl">7.669653</span>    <span class="dv">238</span>           <span class="fl">5.569286</span>      [<span class="dv">7</span>,<span class="dv">14</span><span class="er">)</span>        <span class="cn">TRUE</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a><span class="dv">2</span>          <span class="fl">8.138234</span>    <span class="dv">769</span>          <span class="fl">17.994876</span>      [<span class="dv">7</span>,<span class="dv">14</span><span class="er">)</span>        <span class="cn">TRUE</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="dv">3</span>         <span class="fl">10.287758</span>    <span class="dv">190</span>           <span class="fl">4.446068</span>      [<span class="dv">7</span>,<span class="dv">14</span><span class="er">)</span>        <span class="cn">TRUE</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="dv">4</span>         <span class="fl">33.629502</span>    <span class="dv">323</span>           <span class="fl">7.558316</span>     [<span class="dv">28</span>,<span class="dv">35</span>]        <span class="cn">TRUE</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="dv">5</span>          <span class="fl">7.903030</span>      <span class="dv">0</span>           <span class="fl">0.000000</span>      [<span class="dv">7</span>,<span class="dv">14</span><span class="er">)</span>        <span class="cn">TRUE</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="dv">6</span>         <span class="fl">13.485664</span>    <span class="dv">642</span>          <span class="fl">15.023031</span>      [<span class="dv">7</span>,<span class="dv">14</span><span class="er">)</span>        <span class="cn">TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bias_dev</span><span class="op">$</span><span class="va">sample_id</span><span class="op">$</span><span class="va">Plot</span></span></code></pre></div>
<div class="float">
<img src="figure/bias%20detect%20dev%20plot-1.png" alt="plot of chunk bias detect dev plot"><div class="figcaption">plot of chunk bias detect dev plot</div>
</div>
<ul><li>
<code>threshold = "rank"</code>: Identifies biased genes based solely on rank difference. Genes with rank shifts exceeding <code>nSD_rank</code> are considered biased.</li>
</ul></div>
</div>


  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christine Hou, Jacqui Thompson, Stephanie C. Hicks.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

